import path from 'node:path';

import type {FileInfo} from 'jscodeshift';
import postcss, {Plugin} from 'postcss';

const plugin = (): Plugin => {
  return {
    postcssPlugin: 'insert-stylelint-disable',
    Once(_, {result}) {
      result.messages.forEach((message) => {
        if (message.rule.startsWith('stylelint-polaris/coverage')) {
          message.node.raws.before =
            '// stylelint-disable-next-line -- polaris: generated by polaris-migrator\n';
        }
      });
    },
  };
};

export default async function insertStylelintDisable(file: FileInfo) {
  return postcss([
    require('stylelint')({
      configFile: path.resolve(__dirname, './stylelint.config.js'),
    }),
    plugin(),
  ])
    .process(file.source, {
      from: file.path,
      syntax: require('postcss-scss'),
    })
    .then((result) => result.css);
}
